<!DOCTYPE html>
<html>

<head>
    <title>划价系统</title>
    <meta charset="utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:300,400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,900' rel='stylesheet' type='text/css'>
    <!-- CSS Libs -->
    <link rel="stylesheet" type="text/css" href="../../lib/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/bootstrap-switch.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/checkbox3.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/dataTables.bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/select2.min.css">
    <link rel="stylesheet" type="text/css" href="../../lib/css/jquery.mloading.css">

    <!-- CSS App -->
    <link rel="stylesheet" type="text/css" href="../../css/style.css">
    <link rel="stylesheet" type="text/css" href="../../css/themes/flat-blue.css">
    <link rel="stylesheet" type="text/css" href="../../css/themes/flat-green.css">
    <style>
        .lable {
            padding: 0;
            margin: 0;
            text-align: center;
            font-size: 12px;
            padding-top: 10px;
        }

        .medMoney{
            color: red;
        }

        .modal-footer {
            border: 0;
        }

        .input-group-addon {
            color: red;
        }
    </style>
</head>

<body class="flat-blue">
<div class="app-container">
    <div class="row content-container">
        <nav id="navbar" class="navbar navbar-default navbar-fixed-top navbar-top">
            <div class="container-fluid" style="text-align: center;">
                <div class="navbar-header">
                    <button type="button" class="navbar-expand-toggle">
                        <i class="fa fa-bars icon"></i>
                    </button>
                    <ol class="breadcrumb navbar-breadcrumb">
                        <li>添加处方</li>
                    </ol>

                </div>
                <ul class="nav navbar-nav navbar-right">
                    <button type="button" class="navbar-right-expand-toggle pull-right visible-xs">
                        <i class="fa fa-times icon"></i>
                    </button>
                    <li class="dropdown danger">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                           aria-expanded="false"><i class="fa fa-star-half-o"></i><span
                                class=" totalMsg"></span></a>
                    </li>
                    <li class="dropdown profile">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button"
                           aria-expanded="false"><span class="username"></span> <span class="caret"></span></a>
                        <ul class="dropdown-menu animated fadeInDown">
                            <li class="profile-img">
                            </li>
                            <li>
                                <div class="profile-info">
                                    <h4 class="username"></h4>
                                    <p style="color: red;"><span class="role"></span> ←→ <span
                                            class="teamName"></span></p>
                                    <div class="btn-group margin-bottom-2x" role="group">
                                        <button type="button" class="btn btn-default headimg_exchange"><i
                                                class="fa fa-user"></i> 更换头像
                                        </button>
                                        <button type="button" class="btn btn-default logout"><i
                                                class="fa fa-sign-out"></i> 退出登陆
                                        </button>
                                        <input type="file" accept="image/*" style="display: none;"
                                               name="headimg_exchange" id="headimg_exchange"/>

                                    </div>
                                </div>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
        <div id="sidebar" class="side-menu sidebar-inverse">

        </div>
        <div class="container-fluid">
            <div class="side-body">
                <div class="page-title">
                    <span class="title">划价</span>
                    <div class="description" style="font-size:20px;color:red;"> 1:计算价格：添加药品之前务必选择天数，否则无法计算价格。</div>
                    <div class="description" style="font-size:20px;color:red;"> 2:添加药品：请对应正确药厂。</div>
                    <div class="description" style="font-size:20px;color:red;"> 3:刷新：如果没有获取到最新添加的药厂和药品请点击刷新！</div>
                    <div class="description" style="font-size:20px;color:red;"> 4:添加：没有的疾病请点击添加按钮！</div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <a class="btn btn-primary" onclick="window.history.go(-1)"><span
                                            class="fa fa-chevron-circle-left"></span>返回</a>
                                    <a href="tag"></a>
                                </div>
                                <div class="card-title" style="float:right;text-align: center;">
                                    <div class="">
                                        <a class="btn btn-success reset" style="color:white;display: block;">刷新<span
                                                class="fa fa-chevron-circle-right"></span></a>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <form class="form-horizontal">
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">门诊</label>
                                        <div class="input-group col-sm-5 col-xs-5">
                                            <span class="input-group-addon"><i>*</i>必选项</span>
                                            <input type="text" id="hospId" maxlength="30" class="form-control"  style="display:none" disabled="disabled">
                                            <input type="text" id="hospName" maxlength="30" class="form-control" disabled="disabled">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">患者姓名</label>
                                        <div class="input-group col-sm-5 col-xs-5">
                                            <span class="input-group-addon"><i>*</i>必填项</span>
                                            <input type="text" id="patientName" maxlength="30" class="form-control">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">患者性别</label>
                                        <div class="input-group col-sm-5 col-xs-5">
                                            <div>
                                                <input type="text" id="sex" maxlength="30" class="form-control" disabled="disabled">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="doctorId" class="col-sm-2 control-label">医生</label>
                                        <div class="input-group col-sm-5 col-xs-5">
                                            <div>
                                                <input type="text" id="doctorId" maxlength="30" class="form-control" style="display:none" disabled="disabled">
                                                <input type="text" id="doctorName" maxlength="30" class="form-control" disabled="disabled">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="dId" class="col-sm-2 control-label">疾病名称</label>
                                        <div class="input-group col-sm-5 col-xs-5">
                                            <div>
                                                <input type="text" id="dId" maxlength="30" class="form-control" style="display:none" disabled="disabled">
                                                <input type="text" id="dName" maxlength="30" class="form-control" disabled="disabled">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="illness" class="col-sm-2 col-xs-2 control-label">疾病描述</label>
                                        <div class="col-sm-10 col-xs-10" style="padding-left: 0;">
                                            <textarea class="form-control" id="illness"  maxlength="300" rows="3" disabled="disabled"></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">用药天数</label>
                                        <div class="input-group  col-sm-5 col-xs-5">
                                            <span class="input-group-addon"><i>*</i>必填项</span>
                                            <input type="text" id="days"  maxlength="30"
                                                   class="form-control" placeholder="用药天数（必填，默认30天）">
                                            <input type="text" id="giveDay" maxlength="30"
                                                   class="form-control" placeholder="赠药天数（选填，默认0）">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">内服粉剂抓药规格</label>
                                        <div class="col-sm-2 col-xs-2">
                                            <div>
                                                <input type="text" id="powderDay" maxlength="30" class="form-control" disabled="disabled">
                                            </div>
                                        </div>
                                        <div class="col-sm-5 col-xs-5 pwd">
                                            <span class="input-group-addon"><i>*</i>如有内服粉剂，请必填</span>
                                            <input type="number" id="indays"  maxlength="30"
                                                   class="form-control" placeholder="用药天数 (默认0)">
                                            <!--<input type="number" id="giveindays" maxlength=""-->
                                            <!--class="form-control" placeholder="赠药天数（选填，默认0）">-->
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">外敷粉剂抓药规格</label>
                                        <div class="col-sm-2 col-xs-2">
                                            <div>
                                                <input type="text" id="outpowderDay" maxlength="30" class="form-control" disabled="disabled">
                                            </div>
                                        </div>
                                        <div class="col-sm-5 col-xs-5 outpwd">
                                            <span class="input-group-addon"><i>*</i>如有外敷粉剂，请必填</span>
                                            <input type="number" id="outdays"  maxlength="30"
                                                   class="form-control" placeholder="用药天数 (默认0)">
                                            <!--<input type="number" id="giveoutdays" maxlength="30"-->
                                            <!--class="form-control" placeholder="赠药天数（选填，默认0）">-->
                                        </div>
                                    </div>
                                    <div class="form-group" id="medicine">

                                    </div>


                                    <div class="form-group">
                                        <label for="listPresc" class="col-sm-2 control-label">补方</label>
                                        <div class="input-group col-sm-10 col-xs-10">
                                            <div>
                                                <select id="listPresc" class="col-sm-5 col-xs-5" multiple="multiple"
                                                        title="补方"
                                                        aria-describedby="">
                                                    <optgroup label="请选择补方" class="listPresc">
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">状态</label>
                                        <div class="input-group col-sm-10 col-xs-10">
                                            <span class="input-group-addon"><i>*</i>必填项</span>
                                            <div>
                                                <select id="type" class="col-sm-5" title="状态">
                                                    <optgroup label="请选择状态" class="type">
                                                        <option value="received">已收</option>
                                                        <option value="unreceive">未收</option>
                                                        <option value="dreceive">代收</option>
                                                        <option value="transfer">转账</option>
                                                        <option value="paidAndDreceive">已收+代收</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                            <div class="reBox" style="display: none;">
                                                    <span style="color:red;">已收：<span class="received"
                                                                                      style="color:blue;">25</span></span>
                                                <span style="color:red;">代收：<span class="dreceive"
                                                                                  style="color:blue;">30</span></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">折扣</label>
                                        <div class="input-group col-sm-10">
                                            <div class="col-sm-6">
                                                <input type="text" id="discount" maxlength="10" class="form-control"
                                                       placeholder="8折请填写8（不打折可不填，或填10）">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label" style="color:red;">煎药费</label>
                                        <div class="input-group col-sm-10">
                                            <div class="col-sm-4">
                                                <input type="text" id="decoctMoney" maxlength="30" class="form-control">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label" style="color:red;">总价</label>
                                        <div class="input-group col-sm-10">
                                            <div class="col-sm-4">
                                                <input type="hidden" id="oldMoney" maxlength="30">
                                                <input type="number" id="discountMoney" maxlength="30"
                                                       class="form-control"
                                                       disabled="disabled">
                                            </div>
                                        </div>
                                    </div>
                                    <!--<div class="form-group preBox">
                                        <div class="col-sm-12">
                                            <button type="button" class="btn btn-primary btn-lg preview"
                                                    style="width:100%">保存
                                            </button>
                                        </div>
                                    </div>-->
                                    <div class="form-group saveBox">
                                        <div class="col-sm-12">
                                            <button type="button" class="btn btn-success btn-lg saveBtn"
                                                    style="width:100%">提交
                                            </button>
                                        </div>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="modal fade" id="re_dreceive" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">×</span></button>
                    <h4 class="modal-title" id="feelLabel">已收+代收</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="paidMoney">已收</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="paidMoney">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="unpayMoney">代收</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="unpayMoney">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success col-sm-12 submit">确认</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="add_disease" tabindex="-2" role="dialog" aria-labelledby="addKeshiModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">添加疾病</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group col-xs-12">
                        <div class="col-xs-3">
                            <lable for="disease"
                                   style="height:38px;line-height: 38px;width:100%;color:red;font-size: 18px;">疾病名称：
                            </lable>
                        </div>
                        <input type="text" id="disease" class="form-control col-xs-5">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary save">保存</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <div class="wrapper">
                <span class="pull-right">1.0 <a href="#"><i class="fa fa-long-arrow-up"></i></a></span> © 2017
                Copyright.
                期待更多
                <a href="http://http://www.bj11ss.com/" target="_blank" title="医来伸手">顺昌盛世</a>
                <a href="http://www.bj11ss.com/" title="医来伸手" target="_blank">----医来伸手</a>
            </div>
        </footer>
        <div>
            <!-- Javascript Libs -->
            <script type="text/javascript" src="../../lib/js/jquery.min.js"></script>
            <script type="text/javascript" src="../../lib/js/bootstrap.min.js"></script>
            <script type="text/javascript" src="../../lib/js/Chart.min.js"></script>
            <script type="text/javascript" src="../../lib/js/bootstrap-switch.min.js"></script>

            <script type="text/javascript" src="../../lib/js/jquery.matchHeight-min.js"></script>
            <script type="text/javascript" src="../../lib/js/jquery.dataTables.min.js"></script>
            <script type="text/javascript" src="../../lib/js/dataTables.bootstrap.min.js"></script>
            <script type="text/javascript" src="../../lib/js/select2.full.min.js"></script>

            <!-- Javascript -->
            <script type="text/javascript" src="../../js/app.js"></script>
            <script type="text/javascript" src="../../js/theming.js"></script>
            <script type="text/javascript" src="../../js/themings.js"></script>
            <script type="text/javascript" src="../../lib/js/jquery.mloading.js"></script>

            <script src="../../js/config.js"></script>
            <script src="../../js/uploadImg.js"></script>
            <script src="../../js/session_expire.js"></script>
            <script type="text/javascript" src="../../js/personal_msg.js?"></script>

            <!-- Javascript -->
            <script type="text/javascript">
                $(function () {
                    var search = window.location.search;
                    if (search != "" && search.split("mrId=")[1]) {
                        var mrId = search.split("mrId=")[1].split("&")[0];
                    }
                    $("body").mLoading("show");
                    $.ajax({
                        url: config.rootUrl + "user/medRecordDetail.do",
                        data: {
                            deviceToken: "html5",
                            deviceType: "html5",
                            userId: session_login.info.userId,
                            mrId: mrId
                        },
                        async: true,
                        type: "post",
                        success: function (data) {
                            console.log(data);
                            var info = data.info;
                            hospId=info.hospId;
                            hospName=info.hospName;
                            sexNeed=info.sex;
                            doctorId=info.doctorId;
                            doctorName=info.doctorName;
                            dName=info.dName;
                            illness=info.illness;
                            detail=info.detail;
                            discountNeed=info.discount;
                            discountMoney=info.discountMoney||info.oldMoney;
                            decoctMoney=info.decoctMoney;
                            medicineCost=info.medicineCost;
                            patientName=info.patientName;
                            decoction=info.decoction;
                            decoctionCost=info.decoctionCost;
                            decoctionMoney=info.decoctionMoney;
                            giveDay=info.giveDay;
                            herbalCost=info.herbalCost;
                            herbalMoney=info.herbalMoney;
                            medicineCost=info.medicineCost;
                            medicineMoney=info.medicineMoney;
                            powder=info.powder;
                            powderDay=info.powderDay,
                                powderMonth=info.powderMonth,
                                powderCost=info.powderCost;
                            powderMoney=info.powderMoney;
                            outPowder=info.outPowder,
                                outPowderDay=info.outPowderDay,
                                outPowderMonth=info.outPowderMonth,
                                outPowderMoney=info.outPowderMoney,
                                outPowderCost=info.outPowderCost,
                                patent=info.patent,
                                patentCost=info.patentCost;
                            patentMoney=info.patentMoney,
                                days=info.days;
                            type=info.type;
                            $("#hospId").val(info.hospId);
                            $("#hospName").val(info.hospName);
                            $("#patientName").val(info.patientName);
                            if(info.sex==1){
                                $("#sex").val("女");
                            }else if(info.sex==0){
                                $("#sex").val("男");
                            }
                            $("#doctorId").val(info.doctorId);
                            $("#doctorName").val(info.doctorName);
                            $("#dId").val(info.dId);
                            $("#dName").val(info.dName);
                            $("#illness").val(info.illness);
                            $("#days").val(info.days);
                            $("#giveDay").val(info.giveDay);
                            if(info.powderDay!=null&&info.powderDay!=0){
                                $("#powderDay").val("按天");
                                $("#indays").val(info.powderDay);
                            }else if(info.powderMonth!=null&&info.powderMonth!=0){
                                $("#powderDay").val("按月");
                                $("#indays").val(info.powderMonth);
                            }else {
                                $("#powderDay").val("按总量");
                                $("#indays").val(1);
                                $(".pwd").css("display","none");
                            }
                            if(info.outPowderDay!=null&&info.outPowderDay!=0){
                                $("#outpowderDay").val("按天");
                                $("#outdays").val(info.outPowderDay);
                            }else if(info.outPowderMonth!=null&&info.outPowderMonth!=0){
                                $("#outpowderDay").val("按月");
                                $("#outdays").val(info.outPowderMonth);
                            }else {
                                $("#outpowderDay").val("按总量");
                                $("#outdays").val(1);
                                $(".outpwd").css("display","none");
                            }


                            detail = JSON.parse(info.detail);
                            console.log(detail);
                            // for(var i in detail){
                            //     medMoney["allMoney" + _id] = detail[i].medMoney;
                            //     medMoney["allMoney" + _id] = detail[i].medMoney;
                            // }


                            var _counter = 1;
                            for(var i in detail){
                                var _i=_counter-1;
                                var _html = '<div class="itemFlag itemBox' + _counter + '"><hr><label class="col-sm-2 control-label medText" style="color:green;">药品</label>' +
                                    '<div class="input-group col-sm-10 medBox">' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">价格</p>' +
                                    '<input type="number" value='+ detail[i].medMoney +'  disabled="disabled"  maxlength="30" class="form-control medMoney"  placeholder="价格">'+
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">药品</p>' +
                                    '<input type="text" value=' + detail[i].medicineName + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">用量</p>' +
                                    '<input type="text" id="num' + _counter + '"  value='+ detail[i].grams +' maxlength="30"  class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">类型</p>' +
                                    '<input type="text" value="草药"   maxlength="30"  class="form-control type'+ _counter +'" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-3" style="display: none;">' +
                                    '<p class="lable">药厂</p>' +
                                    '<input type="text" id="medSup' + _counter + '"  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-3" style="display: none;">' +
                                    '<p class="lable">单价</p>' +
                                    '<input type="number" id="salePrice' + _counter + '" value='+ detail[i].salePrice +' maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                                $("#medicine").append(_html);
                                ++_counter;
                            };

                            decoction = JSON.parse(info.decoction);
                            console.log(decoction);
                            for(var i = 0;i<decoction.length;i++ ){

                                var _html = '<div class="itemFlag itemBox' + _counter + '"><hr><label class="col-sm-2 control-label medText" style="color:green;">药品</label>' +
                                    '<div class="input-group col-sm-10 medBox">' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">价格</p>' +
                                    '<input type="number" value='+ eval(decoction[i].grams * decoction[i].salePrice * info.days).toFixed(2) +'  disabled="disabled"  maxlength="30" class="form-control medMoney"  placeholder="价格">'+
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">药品</p>' +
                                    '<input type="text" value=' + decoction[i].medicineName + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">用量</p>' +
                                    '<input type="text" id="num' + _counter + '"  value='+ decoction[i].grams +' maxlength="30"  class="form-control" disabled="disabled" >' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">类型</p>' +
                                    '<input type="text" value="汤药"   maxlength="30"  class="form-control type'+ _counter +'" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-3" style="display: none;">' +
                                    '<p class="lable">药厂</p>' +
                                    '<input type="text" id="medSup' + _counter + '"  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-3" style="display: none;">' +
                                    '<p class="lable">单价</p>' +
                                    '<input type="number" id="salePrice' + _counter + '" value='+ decoction[i].salePrice +' maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                                $("#medicine").append(_html);
                                ++_counter;
                            }

                            patent = JSON.parse(info.patent);
                            console.log(patent);
                            for(var i = 0 ; i < patent.length; i ++){
                                var _html = '<div class="itemFlag itemBox' + _counter + '"><hr><label class="col-sm-2 control-label medText" style="color:green;">药品'+_counter+'</label>' +
                                    '<div class="input-group col-sm-10 medBox">' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">价格</p>' +
                                    '<input type="number"   disabled="disabled"  maxlength="30" class="form-control medMoney"  value="'+patent[i].medMoney+'">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">药品</p>' +
                                    '<input type="text" value=' + patent[i].medicineName + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2" style="display: none;">' +
                                    '<p class="lable">药厂</p>' +
                                    '<input type="text"value=' + patent[i].medicineName + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2" style="display: none;">' +
                                    '<p class="lable">单价</p>' +
                                    '<input type="number" value=' + patent[i].salePrice + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">每日用量</p>' +
                                    '<input type="text" value=' + patent[i].grams + '   maxlength="30"  class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">类型</p>' +
                                    '<input type="text" value="中成药"   maxlength="30"  class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                                $("#medicine").append(_html);
                                ++_counter;
                            }

                            powder = JSON.parse(info.powder);
                            console.log(powder);
                            for(var i = 0 ; i < powder.length ; i++){
                                var _html = '<div class="itemFlag itemBox' + _counter + '"><hr><label class="col-sm-2 control-label medText" style="color:green;">药品'+_counter+'</label>' +
                                    '<div class="input-group col-sm-10 medBox">' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">价格</p>' +
                                    '<input type="number"   disabled="disabled"  maxlength="30" class="form-control medMoney"  value="'+powder[i].medMoney+'">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">药品</p>' +
                                    '<input type="text" value=' + powder[i].medicineName + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2" style="display: none;">' +
                                    '<p class="lable">药厂</p>' +
                                    '<input type="text"value=' + powder[i].medicineName + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2" style="display: none;">' +
                                    '<p class="lable">单价</p>' +
                                    '<input type="number" value=' + powder[i].salePrice + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">每日用量</p>' +
                                    '<input type="text" value=' + powder[i].grams + '   maxlength="30"  class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">类型</p>' +
                                    '<input type="text" value="内服粉剂"   maxlength="30"  class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                                $("#medicine").append(_html);
                                ++_counter;
                            }

                            outPowder = JSON.parse(info.outPowder);
                            console.log(outPowder);
                            for(var i  = 0 ; i< outPowder.length; i++){
                                var _html = '<div class="itemFlag itemBox' + _counter + '"><hr><label class="col-sm-2 control-label medText" style="color:green;">药品'+_counter+'</label>' +
                                    '<div class="input-group col-sm-10 medBox">' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">价格</p>' +
                                    '<input type="number"   disabled="disabled"  maxlength="30" class="form-control medMoney"  value="'+ outPowder[i].medMoney+'">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">药品</p>' +
                                    '<input type="text" value=' + outPowder[i].medicineName + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2" style="display: none;">' +
                                    '<p class="lable">药厂</p>' +
                                    '<input type="text"value=' + outPowder[i].medicineName + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2" style="display: none;">' +
                                    '<p class="lable">单价</p>' +
                                    '<input type="number" value=' + outPowder[i].salePrice + '  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">每日用量</p>' +
                                    '<input type="text" value=' + outPowder[i].grams + '   maxlength="30"  class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">类型</p>' +
                                    '<input type="text" value="外敷粉剂"   maxlength="30"  class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                                $("#medicine").append(_html);
                                ++_counter;
                            }


                            listHospMedicine()
                            //获取门诊药品列表
                            var retMedicineOrder = "";
                            function listHospMedicine() {
                                $("body").mLoading("show");//关闭loading组件
                                $.ajax({
                                    url: config.rootUrl + "user/listMedicine.do",
                                    data: {
                                        deviceToken: "html5",
                                        deviceType: "html5",
                                        userId: session_login.info.userId,
                                        page: "1",
                                        rows: "1000"
                                    },
                                    async: true,
                                    type: 'post',
                                    success: function (data) {
                                        //添加选项内容
                                        var info = data.info;
                                        //收款账户
                                        for (var i in info) {
                                            var dataJson = JSON.stringify(info[i]);
                                            var _option = "<option value='" + info[i].mId + "' data-json='" + dataJson + "'>" + info[i].medicineName+" ￥"+info[i].salePrice+"</option>";
                                            retMedicineOrder += _option;
                                        }
                                        $(".medicine")[0].innerHTML = retMedicineOrder;
                                        $('.item').val("").select2({
                                            placeholder: "请选择药品"
                                        });
                                    },
                                    error: function (xhr, type, errorThrown) {
                                        alert('发生错误！');
                                    },
                                    complete: function () {
                                        $("body").mLoading("hide");//关闭loading组件
                                    }
                                });
                            }


                            // 重构药品序号
                            function medText() {
                                var _item = $(".medText");
                                for (var i = 1; i <= _item.length; i++) {
                                    $(".medText")[i - 1].innerText = "药品" + i;
                                }
                            }
                            $("#listPresc").on("select2:close", function () {
                                calc()
                            })
                            var medMoney = {};
                            var type={typeName:"汤药",type:"tangyao"};
                            $("#medicine").delegate(".tianjia", "click", function () {
                                if ($(this).attr("disabled") == "disabled") {
                                    return;
                                } else {
                                    setDom(type)
                                }
                            })

                            //删除药品
                            $("#medicine").delegate(".del", "click", function () {
                                var _id = $(this).parents(".itemFlag").attr("class").split(" ")[1].split("itemBox")[1];
                                var len = $(".medText").length;
                                $("#medicine")[0].removeChild($('.itemBox' + _id + '')[0]);
                                delete medMoney["allMoney" + _id];
                                delete medMoney["json" + _id];
                                delete medMoney["num" + _id];
                                delete medMoney["mId" + _id];
                                delete medMoney["msId" + _id];
                                delete medMoney["salePrice" + _id];
                                delete medMoney["selectMed" + _id];
                                delete medMoney["medicineStock" + _id];
                                delete medMoney["type" + _id];
                                medText();
                                calc();
                                if (len == "1") {
                                    setDom(type);
                                }
                            })
                            // var hc = localStorage.getItem(medMoney);
                            // console.log(JSON.parse(hc));

                            $("#powderDay").on("select2:close",function(){
                                var powderType = $(this).val();
                                $("#indays").val("");

                                if(powderType=="powdertotal"){
                                    $(".pwd").css("display","none");
                                    $("#indays").val("1");
                                }else if(powderType=="powderdays"){
                                    $(".pwd").css("display","block");
                                    $("#indays").attr("placeholder","用药天数 (默认为0)");
                                }else if(powderType=="powdermonth"){
                                    $(".pwd").css("display","block");
                                    $("#indays").attr("placeholder","用药月数 (默认为0)");
                                }
                            });

                            $("#outpowderDay").on("select2:close",function(){
                                var powderType = $(this).val();
                                $("#outdays").val("");

                                if(powderType=="outpowdertotal"){
                                    $(".outpwd").css("display","none");
                                    $("#outdays").val("1");
                                }else if(powderType=="outpowderdays"){
                                    $(".outpwd").css("display","block");
                                    $("#outdays").attr("placeholder","用药天数 (默认为0)");
                                }else if(powderType=="outpowdermonth"){
                                    $(".outpwd").css("display","block");
                                    $("#outdays").attr("placeholder","用药月数 (默认为0)");
                                }
                            });
                            setDom(type);
                            // 增加药品
                            function setDom(data) {

                                if(data.type=="fenji"){
                                    var _medMon='<input type="number"   disabled="disabled"  maxlength="30" class="form-control medMoney_fenji"  placeholder="价格">';
                                    var placeholder="用量";
                                }else if(data.type=="zhongchengyao"){
                                    _medMon='<input type="number"   disabled="disabled"  maxlength="30" class="form-control medMoney_zhongchengyao"  placeholder="价格">';
                                    placeholder="总量";
                                }else if(data.type=="wfenji"){
                                    _medMon='<input type="number"   disabled="disabled"  maxlength="30" class="form-control medMoney_wfenji"  placeholder="价格">';
                                    placeholder="用量";
                                }else{
                                    _medMon='<input type="number"   disabled="disabled"  maxlength="30" class="form-control medMoney"  placeholder="价格">';
                                    placeholder="每日用量";
                                }
                                var _html = '<div class="itemFlag itemBox' + _counter + '"><hr><label class="col-sm-2 control-label medText" style="color:green;">药品</label>' +
                                    '<div class="input-group col-sm-10 medBox">' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">价格</p>' +_medMon +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">药品</p>' +
                                    '<select class="selectMed' + _counter + ' item"   style="width:100%" title="药品">' +
                                    '<optgroup label="请选择药品" class="medicine">' + retMedicineOrder + '</optgroup>' +
                                    '</select>' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">用量</p>' +
                                    '<input type="text" id="num' + _counter + '"  maxlength="30"  class="form-control" placeholder="' + placeholder + '">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">类型</p>' +
                                    '<select class="type' + _counter + '" style="width:100%" title="类型">' +
                                    '<optgroup label="请选择药品类型" class="medicine">' +
                                    '<option value="tangyao">汤药</option>'+
                                    '<option value="caoyao">草药</option>'+
                                    '<option value="fenji">粉剂</option>'+
                                    '<option value="wfenji">外敷粉剂</option>'+
                                    '<option value="zhongchengyao">中成药</option>'+
                                    '</optgroup>' +
                                    '</select>' +
                                    '</div>' +
                                    '<div class="col-sm-3" style="display: none;">' +
                                    '<p class="lable">药厂</p>' +
                                    '<input type="text" id="medSup' + _counter + '"  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-3" style="display: none;">' +
                                    '<p class="lable">单价</p>' +
                                    '<input type="number" id="salePrice' + _counter + '"  maxlength="30" class="form-control" disabled="disabled">' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">添药</p>' +
                                    '<div class="btn btn-primary tianjia form-control"><span class="icon fa fa-plus-circle"> </span> 增加</div>' +
                                    '</div>' +
                                    '<div class="col-sm-2">' +
                                    '<p class="lable">删除</p>' +
                                    '<div class="btn btn-danger del form-control"><span class="icon fa fa-delicious"> </span> 删除</div>' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                                $("#medicine").append(_html);
                                // 重置下拉框
                                $('.selectMed' + _counter).val("").select2({
                                    placeholder: "请选择药品"
                                });
                                $('.type' + _counter).val(data.type).select2({
                                    placeholder: "请选择药品类型"
                                });
                                $('.type' + _counter).on("select2:close", function () {
                                    var _id = $(this).attr("class").split(" ")[0].split("type")[1];
                                    var typeName=$(this).find("option:selected").text();
                                    var _type=$(this).val();
                                    type={typeName:typeName,type:_type}
                                    medMoney["type" + _id] = _type;
                                    var day=$("#days").val();
                                    var day1 = $("#indays").val();
                                    var day2=$("#outdays").val();
                                    var _json = $('.selectMed' + _id).find("option:selected").attr("data-json");
                                    if(_json){
                                        _json = JSON.parse(_json);
                                        var salePrice = _json.salePrice;
                                    }else{
                                        if(type.type=="fenji"){
                                            $("#num"+_id).attr("placeholder","总量");
                                            $(this).parents(".medBox").find(".medMoney").removeClass("medMoney").addClass("medMoney_fenji");
                                        }  else if(type.type=="zhongchengyao"){
                                            $("#num"+_id).attr("placeholder","总量");
                                            $(this).parents(".medBox").find(".medMoney").removeClass("medMoney").addClass("medMoney_zhongchengyao");
                                        }else if(type.type=="wfenji"){
                                            $("#num"+_id).attr("placeholder","总量");
                                            $(this).parents(".medBox").find(".medMoney").removeClass("medMoney").addClass("medMoney_wfenji");
                                        }else{
                                            $("#num"+_id).attr("placeholder","每日用量");
                                            $(this).parents(".medBox").find(".medMoney_fenji").removeClass("medMoney_fenji").addClass("medMoney");
                                        }
                                        return;
                                    }
                                    if(type.type=="fenji"){
                                        $(this).parents(".medBox").find(".medMoney").removeClass("medMoney").addClass("medMoney_fenji");
                                        $(this).parents(".medBox").find(".medMoney_wfenji").removeClass("medMoney_wfenji").addClass("medMoney_fenji");
                                        $(this).parents(".medBox").find(".medMoney_zhongchengyao").removeClass("medMoney_zhongchengyao").addClass("medMoney_fenji");
                                        if($("#num"+_id).val()!=""){
                                            var num=$("#num"+_id).val();
                                            _need=_need=salePrice*day1*num;
                                            _need=_need.toFixed(2);
                                            $(this).parents(".medBox").find(".medMoney_fenji").val(_need);
                                        }
                                    } else if(type.type=="zhongchengyao"){
                                        $(this).parents(".medBox").find(".medMoney").removeClass("medMoney").addClass("medMoney_zhongchengyao");
                                        $(this).parents(".medBox").find(".medMoney_fenji").removeClass("medMoney_fenji").addClass("medMoney_zhongchengyao");
                                        $(this).parents(".medBox").find(".medMoney_wfenji").removeClass("medMoney_wfenji").addClass("medMoney_zhongchengyao");
                                        if($("#num"+_id).val()!=""){
                                            var num=$("#num"+_id).val();
                                            _need=_need=salePrice*num;
                                            _need=_need.toFixed(2);
                                            $(this).parents(".medBox").find(".medMoney_zhongchengyao").val(_need);
                                        }
                                    }else if(type.type=="wfenji"){
                                        $(this).parents(".medBox").find(".medMoney").removeClass("medMoney").addClass("medMoney_wfenji");
                                        $(this).parents(".medBox").find(".medMoney_fenji").removeClass("medMoney_fenji").addClass("medMoney_wfenji");
                                        $(this).parents(".medBox").find(".medMoney_zhongchengyao").removeClass("medMoney_zhongchengyao").addClass("medMoney_wfenji");
                                        if($("#num"+_id).val()!=""){
                                            var num=$("#num"+_id).val();
                                            _need=_need=salePrice*day2*num;
                                            _need=_need.toFixed(2);
                                            $(this).parents(".medBox").find(".medMoney_wfenji").val(_need);
                                        }
                                    }else{
                                        $(this).parents(".medBox").find(".medMoney_fenji").removeClass("medMoney_fenji").addClass("medMoney");
                                        $(this).parents(".medBox").find(".medMoney_wfenji").removeClass("medMoney_wfenji").addClass("medMoney");
                                        $(this).parents(".medBox").find(".medMoney_zhongchengyao").removeClass("medMoney_zhongchengyao").addClass("medMoney");
                                        if($("#num"+_id).val()!=""){
                                            var num=$("#num"+_id).val();
                                            _need=salePrice*day*num;
                                            _need=_need.toFixed(2);
                                            $(this).parents(".medBox").find(".medMoney").val(_need);
                                        }
                                    }
                                })
                                medText()
                                $('.selectMed' + _counter).on("select2:close", function () {
                                    var _id = $(this).attr("class").split(" ")[0].split("selectMed")[1];
                                    var _type=$('.type' + _id).val();
                                    $("#num" + _id).val("");
                                    $(this).parents(".medBox").find(".medMoney").val("");
                                    var _json = $(this).find("option:selected").attr("data-json");
                                    medMoney["json" + _id] = _json;
                                    _json = JSON.parse(_json);
                                    var salePrice = _json.salePrice;
                                    var _mId = _json.mId;
                                    var _msId = _json.msId;
                                    var _selectMed = _json.medicineName;
                                    var _medicineStock = _json.medicineStock;
                                    // 十八反十九畏
                                    // for (var i = 0; i <= all.length; i++) {
                                    //     if (all[i] == _selectMed) {
                                    //         if (_selectMed == "甘草" || _selectMed == "甘遂" || _selectMed == "大戟" || _selectMed == "海藻" || _selectMed == "芫花") {
                                    //             for (var j = 1; j <= _counter; j++) {
                                    //                 var _med = medMoney["selectMed" + j];
                                    //                 if (_med != _med && _med == "甘遂" || _med == "大戟" || _med == "甘草" || _med == "海藻" || _med == "芫花") {
                                    //                     alert("药品中含有反药：" + _selectMed + _med + "请选择是否删除一种？");
                                    //                 }
                                    //             }
                                    //         }
                                    //         if (_selectMed == "乌头" || _selectMed == "草乌" || _selectMed == "黑顺片" || _selectMed == "附子" || _selectMed == "白附子" || _selectMed == "黑附子" || _selectMed == "制附子") {
                                    //             for (var j = 1; j <= _counter; j++) {
                                    //                 var _med = medMoney["selectMed" + j];
                                    //                 if (_med == "贝母" || _med == "瓜蒌" || _med == "半夏" || _med == "清半夏" || _med == "白蔹" || _med == "白芨") {
                                    //                     alert("药品中含有反药：" + _selectMed + _med + "请选择是否删除一种？");
                                    //                 }
                                    //             }
                                    //         }
                                    //         if (_selectMed == "藜芦" || _selectMed == "人参" || _selectMed == "沙参" || _selectMed == "丹参" || _selectMed == "南沙参" || _selectMed == "北沙参" || _selectMed == "玄参" || _selectMed == "元参" || _selectMed == "细辛" || _selectMed == "苦参" || _selectMed == "芍药" || _selectMed == "白芍药" || _selectMed == "赤芍药" || _selectMed == "白芍" || _selectMed == "赤芍") {
                                    //             for (var j = 1; j <= _counter; j++) {
                                    //                 var _med = medMoney["selectMed" + j];
                                    //                 if (_med != _selectMed && _med == "藜芦" || _med == "人参" || _med == "沙参" || _med == "丹参" || _med == "南沙参" || _med == "北沙参" || _med == "玄参" || _med == "元参" || _med == "细辛" || _med == "苦参" || _med == "芍药" || _med == "白芍药" || _med == "赤芍药" || _med == "白芍" || _med == "赤芍") {
                                    //                     alert("药品中含有反药：" + _selectMed + _med + "请选择是否删除一种？");
                                    //                 }
                                    //             }
                                    //         }
                                    //
                                    //     }
                                    // }
                                    medMoney["_id"] = _id;
                                    medMoney["selectMed" + _id] = _selectMed;
                                    medMoney["mId" + _id] = _mId;
                                    medMoney["msId" + _id] = _msId;
                                    medMoney["type" + _id] = _type;
                                    $('#salePrice' + _id).val(salePrice);
                                    medMoney["salePrice" + _id] = salePrice;
                                    medMoney["medicineStock" + _id] = _medicineStock;
                                    // calc();

                                    //选择完药品之后，用量框获取光标
                                    $('#num'+_id).focus();

                                });
                                $("#num" + _counter).on("input", function (e) {
                                    var _id = $(this).attr("id").split(" ")[0].split("num")[1];
                                    check("#num" + _id);
                                    var _days = $("#days").val()||30;
                                    var _days1 = $("#indays").val()||0;
                                    var _days2 = $("#outdays").val()||0;
                                    var _giveDay = $("#giveDay").val()||0;
                                    // var _all_day=Number(_days)+Number(_giveDay);
                                    var medicineStock = medMoney["medicineStock" + _id];
                                    medMoney["num" + _id] = $(this).val();
                                    if (medMoney["num" + _id] * _days > medicineStock) {
                                        $(this).css({"border-color": "red"});
                                    } else {
                                        $(this).css({"border-color": "green"});
                                    }
                                    if (medMoney["num" + _id] * _days1 > medicineStock) {
                                        $(this).css({"border-color": "red"});
                                    } else {
                                        $(this).css({"border-color": "green"});
                                    }
                                    if (medMoney["num" + _id] * _days2 > medicineStock) {
                                        $(this).css({"border-color": "red"});
                                    } else {
                                        $(this).css({"border-color": "green"});
                                    }
                                    if($(this).parents(".medBox").find(".medMoney").length==1){
                                        var allMoney = medMoney["salePrice" + _id] * medMoney["num" + _id] * _days;
                                        allMoney = allMoney.toFixed(2);
                                        medMoney["allMoney" + _id] = allMoney;
                                        $(this).parents(".medBox").find(".medMoney").val(allMoney);
                                    }else if($(this).parents(".medBox").find(".medMoney_fenji").length==1){
                                        var allMoney = medMoney["salePrice" + _id] * medMoney["num" + _id] * _days1;
                                        allMoney = allMoney.toFixed(2);
                                        medMoney["allMoney" + _id] = allMoney;
                                        $(this).parents(".medBox").find(".medMoney_fenji").val(allMoney);
                                    }else if($(this).parents(".medBox").find(".medMoney_zhongchengyao").length==1){
                                        var allMoney = medMoney["salePrice" + _id] * medMoney["num" + _id];
                                        allMoney = allMoney.toFixed(2);
                                        medMoney["allMoney" + _id] = allMoney;
                                        $(this).parents(".medBox").find(".medMoney_zhongchengyao").val(allMoney);
                                    }else if($(this).parents(".medBox").find(".medMoney_wfenji").length==1){
                                        var allMoney = medMoney["salePrice" + _id] * medMoney["num" + _id] * _days2;
                                        allMoney = allMoney.toFixed(2);
                                        medMoney["allMoney" + _id] = allMoney;
                                        $(this).parents(".medBox").find(".medMoney_wfenji").val(allMoney);
                                    }
                                    calc();

                                    //用量输入完成之后，敲击回车键 触发添加药品按钮
                                })
                                var aa = 1;
                                $("#num" + _counter).keyup(function(e){
                                    if(e.keyCode==13){
                                        if(aa!=1){
                                            setDom(type);
                                        }
                                        aa++;
                                    }
                                })

                                //点击添加药品后，自动打开下一个药品的下拉框
                                $('.selectMed'+_counter).select2("open");

                                ++_counter;

                                console.log(medMoney);
                            }



                            $("#discount").on("input", function () {
                                check("#discount");
                                var discount = $("#discount").val();
                                if (discount > 10 || discount < 7) {
                                    alert("折扣请填写7-10之间的数值！");
                                    $("#discount").val("");
                                    $("#discount").focus();
                                }
                                calc();
                            })
                            $("#days").on("input", function () {
                                calcAllMoney();
                            })
                            $("#powderDay").on("select2:close",function(){
                                calcAllMoney();
                            });
                            $("#outpowderDay").on("select2:close",function(){
                                calcAllMoney();
                            });
                            $("#indays").on("input", function () {
                                calcAllMoney();
                            })
                            $("#outdays").on("input", function () {
                                calcAllMoney();
                            })
                            $("#giveDay").on("input", function () {
                                check("#giveDay");
                            })

                            function calcAllMoney() {
                                var _days = $("#days").val()||30;
                                var _days1 = $("#indays").val()||0;
                                var _days2 = $("#outdays").val()||0;
                                var _giveDay = $("#giveDay").val()||0;

                                check("#days");
                                check("#indays");
                                check("#outdays");
                                for (var i = 1; i < _counter; i++) {

                                    var medicineStock = medMoney["medicineStock" + i];
                                    var num = $("#num" + i).val();
                                    var salePrice = $("#salePrice" + i).val();
                                    if($(".type"+i).val()=="fenji"){
                                        var allMoney = (_days1 * num * salePrice).toFixed(2);
                                    }else if($(".type"+i).val()=="wfenji"){
                                        allMoney = (_days2 * num * salePrice).toFixed(2);
                                    }else{
                                        allMoney = (_days * num * salePrice).toFixed(2);
                                    }
                                    // var allMoney = (_days1 * num * salePrice).toFixed(2);
                                    if ("allMoney" + i in medMoney) {
                                        medMoney["allMoney" + i] = allMoney;
                                    }
                                    $("#num" + i).parents(".medBox").find(".medMoney").val(allMoney);
                                    $("#num" + i).parents(".medBox").find(".medMoney_fenji").val(allMoney);
                                    $("#num" + i).parents(".medBox").find(".medMoney_wfenji").val(allMoney);
                                    if (allMoney > medicineStock) {
                                        $("#num" + i).css({"border-color": "red"});
                                        $(this).css({"border-color": "red"});
                                    } else {
                                        $("#num" + i).css({"border-color": "green"});
                                        $(this).css({"border-color": "green"});
                                    }
                                }
                                calc();
                            }

                            $("#decoctMoney").on("input", function () {
                                check("#decoctMoney");
                                calc();
                            })
                            $("#paidMoney").on("input", function () {
                                check("#paidMoney");
                            })
                            $("#unpayMoney").on("input", function () {
                                check("#unpayMoney");
                            })
                            $(".submit").on("click", function () {
                                var paidMoney = $("#paidMoney ").val();
                                var unpayMoney = $("#unpayMoney ").val();
                                if (paidMoney == "" || unpayMoney == "" || unpayMoney < 0 || paidMoney < 0) {
                                    alert("请正确填写!");
                                } else {
                                    $("#re_dreceive").modal('hide');
                                    $(".reBox").css('display', "block");
                                    $(".received").text(paidMoney);
                                    $(".dreceive").text(unpayMoney);
                                }
                            })


                            function check(id) {
                                var obj = $(id)[0];
                                obj.value = obj.value.replace(/[^\d.]/g, "");  //清除“数字”和“.”以外的字符
                                obj.value = obj.value.replace(/\.{2,}/g, "."); //只保留第一个. 清除多余的
                                obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
                                obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d\d\d\d).*$/, '$1$2.$3');//只能输入五个小数
                                if (obj.value.indexOf(".") < 0 && obj.value != "") {//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
                                    obj.value = parseFloat(obj.value);
                                }
                            }

                            //计算总价和折扣价
                            function calc() {
                                var medMoneys = $(".medMoney");
                                var medMoneys_fenji = $(".medMoney_fenji");
                                var medMoneys_zhongchengyao = $(".medMoney_zhongchengyao");
                                var medMoneys_wfenji = $(".medMoney_wfenji");
                                var _days = $("#days").val()||30;
                                var _days1 = $("#indays").val()||0;
                                var _days2 = $("#outdays").val()||0;
                                var allCount = 0;
                                var moneys = 0;
                                var discount = $("#discount").val() || 10;
                                discount = discount / 10;
                                var decoctMoney = $("#decoctMoney").val() || 0;
                                for (var i = 0; i < medMoneys.length; i++) {
                                    allCount += Number(medMoneys[i].value);
                                }
                                for (var i = 0; i < medMoneys_fenji.length; i++) {
                                    allCount += Number(medMoneys_fenji[i].value);
                                }
                                for (var i = 0; i < medMoneys_wfenji.length; i++) {
                                    allCount += Number(medMoneys_wfenji[i].value);
                                }
                                for (var i = 0; i < medMoneys_zhongchengyao.length; i++) {
                                    allCount += Number(medMoneys_zhongchengyao[i].value);
                                }
                                var listPresc = $("#listPresc").val();
                                if (listPresc) {
                                    for (var i = 0; i < listPresc.length; i++) {
                                        var price = JSON.parse(listPresc[i]);
                                        price = price[price.length - 1].price;
                                        moneys += Number(price)
                                    }
                                }
                                var _temp = allCount + Number(decoctMoney) + Number(moneys) * _days;
                                $("#oldMoney").val(_temp);
                                var discountMoney = ((discount * allCount) + Number(decoctMoney) + Number(moneys) * _days).toFixed(2);
                                $("#discountMoney").val(discountMoney);
                            }

                            $("#type").on("select2:close", function () {
                                var val = $(this).val();
                                $(".reBox").css('display', "none");
                                if (val == "paidAndDreceive") {
                                    $("#re_dreceive").modal();
                                }
                            });

                            console.log(decoction);
                            //点击提交
                            $(".saveBtn").on("click", function () {
                                console.log(decoction);
                                var hospId=$("#hospId").val();
                                var patientName = $("#patientName").val();
                                if (patientName == "") {
                                    alert("请填写患者名字！");
                                    $("body").mLoading("hide");//关闭loading组件
                                    return;
                                }
                                // var meds = $(".medMoney");
                                // for (var i = 0; i < meds.length; i++) {
                                //     if ($(meds[i]).val() == "" || $(meds[i]).val() == "0") {
                                //         alert("药品信息录入不完全，请仔细检查！");
                                //         $("body").mLoading("hide");//关闭loading组件
                                //         return;
                                //     }
                                // }

                                var sex = $("#sex").val();
                                if(sex=="男"){
                                    sex = 0
                                }else if(sex=="女"){
                                    sex = 1;
                                }
                                var patientName = $("#patientName").val();
                                var dId = $("#dId").val();
                                var doctorId = $("#doctorId").val();
                                //草药 汤药天数
                                var _days = $("#days").val()||30;
                                console.log($("#powderDay").val());
                                console.log($("#outpowderDay").val());
                                //内服药剂开药规格


                                //判断选择天/月/总量
                                if($("#powderDay").val()=="powderdays"){
                                    var _days1 = $("#indays").val()||0;
                                    var PowderDay = _days1;
                                    var PowderMonth = 0;
                                }else if($("#powderDay").val()=="powdermonth"){
                                    _days1 = $("#indays").val()||0;
                                    PowderMonth = _days1;
                                    PowderDay = 0;
                                }else if($("#powderDay").val()=="powdertotal"){
                                    PowderDay = 0;
                                    PowderMonth = 0;
                                }

                                //外敷药剂开药规格
                                if($("#outpowderDay").val()=="outpowderdays"){
                                    var _days2 = $("#outdays").val()||0;
                                    var outPowderDay = _days2;
                                    var outPowderMonth = 0;
                                }else if($("#outpowderDay").val()=="outpowdermonth"){
                                    _days2 = $("#outdays").val()||0;
                                    outPowderDay = 0;
                                    outPowderMonth = _days2;
                                }else if($("#outpowderDay").val()=="outpowdertotal"){
                                    outPowderDay = 0;
                                    outPowderMonth = 0;
                                }
                                var _giveDay = $("#giveDay").val()||0;
                                var illness = $("#illness").val();
                                var paidMoney = $("#paidMoney ").val();
                                var unpayMoney = $("#unpayMoney ").val();
                                var decoctMoney = $("#decoctMoney").val();
                                var type = $("#type ").val();
                                var discount1 = $("#discount ").val();
                                var oldMoney = $("#oldMoney ").val();
                                oldMoney=Number(oldMoney).toFixed(2);
                                var discountMoney = $("#discountMoney ").val();
                                discountMoney=Number(discountMoney).toFixed(2);
                                //药品详情
                                //草药
                                // var detail = [];
                                console.log(decoction);
                                // if(detail == undefined){
                                //     var detail = []
                                // }
                                // 汤药
                                // var decoction = [];
                                // if(decoction  == undefined){
                                //     var decoction = []
                                // }
                                // 粉剂
                                // var powder = [];
                                // if(powder  == undefined){
                                //     var powder = []
                                // }
                                /*外敷粉剂*/
                                // var outPowder = [];
                                // if(outPowder  == undefined){
                                //     var outPowder = []
                                // }
                                // 中成药
                                // var patent = [];
                                // if(patent  == undefined){
                                //     var patent = []
                                // }
                                // 总成本
                                // medicineCost +=medicineCost;
                                // // 草药成本
                                // herbalCost += herbalCost;
                                // // 汤药成本
                                // decoctionCost += decoctionCost;
                                // // 粉剂成本
                                // powderCost += powderCost;
                                // //外敷药剂成本
                                // outPowderCost += outPowderCost;
                                // // 中成药成本
                                // patentCost += patentCost;
                                // // 草药售价
                                // herbalMoney  += herbalMoney;
                                // // 汤药售价
                                // decoctionMoney += decoctionMoney;
                                // // 粉剂售价
                                // powderMoney += powderMoney;
                                // //外敷药剂售价
                                // outPowderMoney += outPowderMoney;
                                // // 中成药售价
                                // patentMoney += patentMoney;
                                for (var i in medMoney) {
                                    if (typeof medMoney[i] == "string" && i.indexOf("json") == "0") {
                                        var item = i.split("json")[1];
                                        var json_data = JSON.parse(medMoney["json"+item]);
                                        switch (medMoney["type" + item]){
                                            case "caoyao":
                                                herbalCost += json_data.buyPrice*medMoney["num" + item];
                                                herbalMoney += json_data.salePrice*medMoney["num" + item];
                                                json_data.medMoney = medMoney["allMoney" + item];
                                                json_data.grams = medMoney["num" + item];
                                                detail.push(json_data);
                                                break;
                                            case "tangyao":
                                                decoctionCost += json_data.buyPrice*medMoney["num" + item];
                                                decoctionMoney += json_data.salePrice*medMoney["num" + item];
                                                json_data.medMoney = medMoney["allMoney" + item];
                                                json_data.grams = medMoney["num" + item];
                                                decoction.push(json_data);
                                                break;
                                            case "fenji":
                                                powderCost += json_data.buyPrice*medMoney["num" + item];
                                                powderMoney += json_data.salePrice*medMoney["num" + item];
                                                json_data.medMoney = medMoney["allMoney" + item];
                                                json_data.grams = medMoney["num" + item];
                                                powder.push(json_data);
                                                break;
                                            case "wfenji":
                                                outPowderCost += json_data.buyPrice*medMoney["num" + item];
                                                outPowderMoney += json_data.salePrice*medMoney["num" + item];
                                                json_data.medMoney = medMoney["allMoney" + item];
                                                json_data.grams = medMoney["num" + item];
                                                outPowder.push(json_data);
                                                break;
                                            case "zhongchengyao":
                                                patentCost += json_data.buyPrice*medMoney["num" + item];
                                                patentMoney += json_data.salePrice*medMoney["num" + item];
                                                json_data.medMoney = medMoney["allMoney" + item];
                                                // patentMoney += json_data.medMoney;
                                                json_data.grams = medMoney["num" + item];
                                                patent.push(json_data);
                                                break;
                                        }
                                    }
                                }


                                // 解决精度问题
                                medicineCost = (herbalCost+decoctionCost+powderCost).toFixed(2);
                                herbalMoney=herbalMoney.toFixed(2);
                                decoctionMoney=decoctionMoney.toFixed(2);
                                powderMoney=powderMoney.toFixed(2);
                                patentMoney=patentMoney.toFixed(2);
                                outPowderMoney=outPowderMoney.toFixed(2);

                                outPowderCost=outPowderCost.toFixed(2);
                                patentCost=patentCost.toFixed(2);
                                herbalCost=herbalCost.toFixed(2);
                                decoctionCost=decoctionCost.toFixed(2);
                                powderCost=powderCost.toFixed(2);
                                if (detail.length == "0"&&decoction.length == "0"&&powder.length == "0"&&patent.length=="0"&&outPowder.length=="0") {
                                    alert("至少需要添加一种药！");
                                    $("body").mLoading("hide");//关闭loading组件
                                    return;
                                }

                                if(powder.length != "0" && _days1 ==""){
                                    alert("您未选择内服粉剂抓药规格！");
                                    return;
                                }
                                if(outPowder.length != "0" && _days2 ==""){
                                    alert("您未选择外敷粉剂抓药规格！");
                                    return;
                                }
                                $("body").mLoading("show");
                                console.log(detail);
                                console.log(decoction);
                                console.log(powder);
                                console.log(outPowder);
                                console.log(patent);
                                /*在这里调用上传接口*/
                                $.ajax({
                                    url: config.rootUrl + "user/addMedcineRecord.do",
                                    data: {
                                        deviceToken: "html5",
                                        deviceType: "html5",
                                        userId: session_login.info.userId,
                                        patientName: patientName,

                                        illness: illness || "",
                                        dId: dId,
                                        hospId: hospId,
                                        sex: sex,isSimple: 1,
                                        doctorId: doctorId,
                                        days: _days,
                                        PowderDay:PowderDay,
                                        PowderMonth:PowderMonth,
                                        outPowderDay:outPowderDay,
                                        outPowderMonth:outPowderMonth,
                                        giveDay: _giveDay,
                                        type: type,
                                        discount: discount1,
                                        herbalCost: herbalCost,
                                        herbalMoney: herbalMoney,
                                        decoctionCost: decoctionCost,
                                        decoctionMoney: decoctionMoney,
                                        powderCost: powderCost,
                                        outPowderCost:outPowderCost,
                                        powderMoney: powderMoney,
                                        outPowderMoney:outPowderMoney,
                                        patentCost:patentCost,
                                        patentMoney:patentMoney,
                                        medicineCost: medicineCost,
                                        oldMoney: oldMoney,
                                        unpayMoney: unpayMoney || "",
                                        paidMoney: paidMoney || "",
                                        discountMoney: discountMoney,
                                        decoctMoney: decoctMoney,
                                        detail: JSON.stringify(detail),
                                        decoction: JSON.stringify(decoction),
                                        powder: JSON.stringify(powder),
                                        outPowder:JSON.stringify(outPowder),
                                        patent: JSON.stringify(patent)
                                    },
                                    async: true,
                                    type: 'post',
                                    success: function (data) {
                                        alert(data.msg);
                                        if (data.code == "1") {
                                            window.history.go(-1)
                                        }
                                    },
                                    error: function (xhr, type, errorThrown) {
                                        alert('发生错误！');
                                    },
                                    complete: function () {
                                        $("body").mLoading("hide");//关闭loading组件
                                    }
                                });
                            })
                        },
                        error: function () {
                            alert("网络错误");
                        },
                        complete: function () {
                            $("body").mLoading("hide");//关闭loading组件
                        }
                    });
                })
            </script>

</body>

</html>